<!DOCTYPE html>
<html>
<meta charset="utf-8">
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" type="text/css"/>
<link rel="stylesheet" href="http://host.coxmediagroup.com/ajc/digitalprojects/global/css/iFrame_Medley.css"type="text/css"/>
<style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: auto;
  padding-top: 40px;
  position: relative;
  width: 960px;
}

/*button {
  position: absolute;
  right: 10px;
  top: 10px;
}*/

.bullet { font: 10px sans-serif;}
/*.bullet .marker { stroke: #000; stroke-width: 2px;}*/
.bullet .tick line { stroke: #666; stroke-width: .5px; }
.bullet .range.s0 { fill: #eee; }
.bullet .range.s1 { fill: #ddd; }
.bullet .range.s2 { fill: #ccc; }
.bullet .measure.s0, .bullet .measure.s1 { fill: steelblue; }
.bullet .bonus .measure.s0 { fill: lightsteelblue; }
/*.bullet .measure.s1 { fill: steelblue; }*/
.bullet .title { font-size: 13px; font-weight: bold;}
.bullet .subtitle { fill: #999; margin-top:3px;}
.tiptitl{font-weight:bold}

</style>
<body>
<p id="menu"><b>Jobs promised vs. Jobs created </b><br>County: <select id="countySelect"></select><br/>Performance <select id="performanceSelect"></select><br/><button id="sortMe">Reverse order</button></p>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="incentives.js"></script>
<script src="http://code.jquery.com/jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="http://code.jquery.com/ui/1.10.2/jquery-ui.min.js" type="text/javascript"></script>
<script>

var data1, svg;
var setcountyMenu;
var countyMenuArr = [];
var margin = {top: 5, right: 20, bottom: 20, left: 300},
    width = 960 - margin.left - margin.right,
    height = 50 - margin.top - margin.bottom;

var chart = d3.bullet()
    .width(width)
    .height(height);

var countyMenu = d3.select("#countySelect")
	.on("change", change);
	
var performanceMenu = d3.select("#performanceSelect")
	.on("change", changePerformance);
	
function sortBars(){	
	d3.select("body").selectAll("svg").sort(function(a, b){		
		if(sortOrder){
			return d3.ascending(a.ratio, b.ratio);
		}
		else{
			return d3.descending(a.ratio,b.ratio);
		}	
	})
	.transition().duration(1000);
	
	sortOrder = !sortOrder;
}
performanceMenu.append("option").text("All");	
performanceMenu.append("option").text("Met promise");
performanceMenu.append("option").text("Did not meet promise");
performanceMenu.append("option").text("Funds recovered");
	
var sortOrder = false;		
d3.select("#sortMe").on("click", function() {
	sortBars();
});

d3.json("incentives.json", function(error, data) {
	data1 = data;
	for (var i=0; i<data1.length; i++){
		//get rid of some irregular ones that don't make sense with our presentation
		if(data1[i].Beneficiaries === "" || data1[i].JobsPromised === null || data1[i].JobsPromised === undefined || data[i].JobsPromised === 0 || data[i].JobsPromised === []){
			data1.splice(i, 1);
		}
		var ratio = (data1[i].JobsDelivered/data1[i].JobsPromised);
		if(ratio === undefined || isNaN(ratio) || ratio === null){
			ratio = 0;
		}
		data1[i].ratio = ratio;
		//if they exceeded promised jobs, create a new bar to show distinction. Creating property .JobsDelivered2 to hold our array
		if(ratio > 1){
			data1[i].JobsDelivered2 = [data1[i].JobsPromised, data1[i].JobsDelivered];
		}
		//rangez is expecting an array bc of what we did above 
		else{
			data1[i].JobsDelivered2 = [data[i].JobsDelivered];
		}
		
		if(data1[i].COUNTY != "Multi-County"){
			data1[i].COUNTY = data1[i].COUNTY + " County";
		}
	}

//	data1 = data1.sort(function(a, b) { return b.ratio - a.ratio; });
	doSVG(data1);

	//we only want one of each county in our menu so we need to check and see if it's already in there
	setcountyMenu = function(){
		countyMenuArr.push("All Counties");//This isn't in the data so we need to create it
		data1.filter(function(v, i) {		
				if(countyMenuArr.indexOf(v.COUNTY) != -1){ return true;}
				else{countyMenuArr.push(v.COUNTY); return false;};
		});
		return countyMenuArr.sort();//Alphabetize
	}
	//add counties from the data to the menu
	countyMenu.selectAll("option")
		.data(setcountyMenu)
		.enter().append("option")
			.text(function(d) {return d;});
});//d3.json()

var filterCounties = function(d){
	var selected = countyMenu.property("value");
	performanceMenu.property("value", "All")/*.node().focus()*/;	
	var myfilter = data1.filter(function(v) {
		if(selected != "All Counties"){return (v.COUNTY) === selected;}
		else{return true;};
	});
	//	doSVG(myfilter, counties);
	doSVG(myfilter);	
}
//might use this later to allow removal/addition of deobligated entries
/*filterObligated = function(d){
	var selected = performanceMenu.property("value");
	countyMenu.property("value", "All Counties");
	var myfilter = data1.filter(function(v) {
		if(selected != "All"){ if(selected === "Yes"){return v.Status1 === "Deob"} else{ return v.Status1 != "Deob"}}
		else{return true;};
	});	
	doSVG(myfilter);	
}*/
var filterPerformance = function(d){
	var selected = performanceMenu.property("value");
	countyMenu.property("value", "All Counties")/*.node().focus()*/;
	var myfilter = data1.filter(function(v){
		if(selected != "All"){if(selected === "Met promise"){return v.MetJobGoal === "Y"} else if(selected === "Funds recovered"){return v.Status1 === "Deob"} else{return v.MetJobGoal === "N"};}
		else{return true;};
	});
	doSVG(myfilter);
}
function doSVG(data){
	//svg = d3.select("body").data(data1).selectAll("svg")
	svg = d3.select("body").selectAll("svg")
	      .data(data, function(d) { return d.Serial; });//to keep the bars in the same place, get rid of the function. 
			
	svg.exit().transition().duration(0)		
	//.attr("x", -x1.rangeBand())
		.remove();

	var svgEnter = svg.enter().append("svg")
						.attr("class", "bullet")	
	      				.attr("width", width + margin.left + margin.right)
	      				.attr("height", height + margin.top + margin.bottom)
	    				.append("g")
	      					.attr("transform", "translate(" + margin.left + "," + margin.top + ")")
							.attr("class", "holder")			
							.append("g")
								.style("text-anchor", "end")
		      					.attr("transform", "translate(-6," + height / 2 + ")")//;
								//.attr("class", "textanchor");
	
	svgEnter.append("text")
		.attr("class", "title")
		.text(function(d) { return d.Beneficiaries; });	
		
	svgEnter.append("text")
		.attr("class", "subtitle")
		.attr("dy", "1em")
		.text(function(d, i){ return d.COUNTY;});
				
//	d3.transition(svg).select(".holder").call(chart.duration(1000));
	svg.select(".holder").call(chart.duration(1000));
	sortBars();
	//change the color of the over-acheiver bar
	svg.select(".holder")
		.attr("class", function(d){ if(d.ratio >1){return "bonus"} else{ return }});
	
		$(document).tooltip({
			items: "svg", 
			content: function(){ 
				var data = this.__data__;
				var tip = "<span class='tip'><span class='tiptitl'>Beneficiary:</span> "+data.Beneficiaries+"<br/><span class='tiptitl'>Jobs Promised:</span> "+data.JobsPromised+"<br/><span class='tiptitl'>Jobs Delivered:</span> "+data.JobsDelivered+"<br/><span class='tiptitl'>Grant amount:</span> $"+data.Grant_Amt;
				if(data.Recaptured_Deob != null){
					tip += "<br/><span class='tiptitl'>Recaptured funds:</span> $"+data.Recaptured_Deob
				}
				tip += "<br/><span class='tiptitl'>Description: </span>"+data.Description+"</span>"
				return tip;
			}
		});
}//doSVG

function change() {
  clearTimeout(timeout);
filterCounties();
//svg.datum(data1).call(chart.duration(1000));
  /*d3.transition()
      .duration(750)
      .each(shuffle);*/
}
function changePerformance() {
	clearTimeout(timeout);
	filterPerformance();
}
	
var timeout = setTimeout(function() {
	//  menu.property("value", "All Counties").node().focus();
//	deobligatedMenu.property("value", "All").node().focus();
//	filterPerformance();
}, 5000);

</script>
	
</body>
</html>