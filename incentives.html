<!DOCTYPE html>
<html>
<meta charset="utf-8">
<!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<title>Does Georgia get bang for its economic development bucks?</title>
<base target="_parent" />
<link rel="stylesheet" href="http://alt.coxnewsweb.com/ajc/_newsapps/libraries/css/skeleton/base.css" type="text/css"/>
<link rel="stylesheet" href="http://alt.coxnewsweb.com/ajc/_newsapps/libraries/css/skeleton/skeleton.css" type="text/css"/>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" type="text/css"/>
<link rel="stylesheet" href="http://host.coxmediagroup.com/ajc/digitalprojects/global/css/iFrame_Medley.css" type="text/css"/>
<style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: auto;
  padding-top: 40px;
  position: relative;
  width: 100%;
}

/*button {
  position: absolute;
  right: 10px;
  top: 10px;
}*/
button{
	margin-top:1.1em;
	margin-bottom:0;
}
.bullet { font: 10px sans-serif;}
/*.bullet .marker { stroke: #000; stroke-width: 2px;}*/
.bullet .tick line { stroke: #666; stroke-width: .5px; }
.bullet .range.s0 { fill: #CED1D1; }
#legend{
	right:0;
	float:right;
	text-align:center;
}
#legend #promisedKey { 
	border-bottom:25px solid #CED1D1;
/*	background-color: #eee;		
	display:inline-block; 
	width:30px; 
	height:25px; 
	margin:-2px;	
	position:relative;
	top:6px;*/
}
#legend #deliveredKey {
/*	display:inline-block;
	width:30px;
	height:8px;
	background-color: #366DA5;
	position:relative;*/
	/*top:10px;*/
	border-bottom:8px solid #366da5;
	padding-bottom:11px;
}
#legend #bonusKey{
	border-bottom:8px solid #A0B7D6;
	padding-bottom:11px;
}
.menuGroup{
	display:absolute;
	padding:5px;
	margin:5px;
	/*height:60px;*/
}

.bullet .range.s1 { fill: #ddd; }
.bullet .range.s2 { fill: #ccc; }
.bullet .measure.s0, .bullet .measure.s1 { fill: steelblue; }
.bullet .bonus .measure.s0 { fill: lightsteelblue; }
/*.bullet .measure.s1 { fill: steelblue; }*/
.bullet .title { font-size: 12px; font-weight: bold;}
.bullet .subtitle { fill: #999; margin-top:3px;}
.tiptitl{font-weight:bold}

</style>
<script>
function detectSVG(){
	if (Modernizr.svg) {
		document.getElementById("incentives-chart").style.display = "block";
	//	document.getElementById("fallback").style.display = "none";
	} else {
		document.getElementById("fallback").style.display = "block";
		document.getElementById("incentives-chart").style.display = "none";
	}
}
</script>
<body class="container twelve columns" onload="detectSVG()">
	<!--[if lte IE 8]>
	<div id="fallback" style="display:block;"><div style="margin:15px 0px 0px 0px;font-family:'Arial'; color:#777;font-size:12px;">Your browser is out of date. Please upgrade your browser to the latest version to view this graphic.</div></div>
	<style type="text/css">
	#incentives-chart {display:none;} 
	#legend {display:none;}</style>
	<![endif]-->
<div class="container nine columns.omega">
	<div class="three columns alpha">County<select id="countySelect"></select></div>
	<div class="three columns ">Performance<select id="performanceSelect"></select></div>
	<div class="three columns"><button id="sortMe"></button></div>
</div>

<div id="legend" class="container.omega seven columns.omega">
	<div id="promisedKey" class="menuGroup two columns">Jobs promised</div>
	<div id="deliveredKey" class="menuGroup two columns">Jobs created</div>
	<div id="bonusKey" class="menuGroup four columns">Jobs created above promise</div>
</div>
<div id="incentives-chart" class="container twelve columns"></div>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="incentives.js"></script>
<script src="http://code.jquery.com/jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="http://code.jquery.com/ui/1.10.2/jquery-ui.min.js" type="text/javascript"></script>
<script src="http://alt.coxnewsweb.com/ajc/_newsapps/libraries/browsersupport/modernizr.custom.16715.js" type="text/javascript"></script>
<script>

var data1, svg;
var setcountyMenu;
var countyMenuArr = [];

var margin = {top: 5, right:$("body").width()*.03, bottom: 20, left: $("body").width()*.1},
    width = $("body").width() - margin.left - margin.right,
    height = 50 - margin.top - margin.bottom;

var chart = d3.bullet()
    .width(width)
    .height(height);

var countyMenu = d3.select("#countySelect")
	.on("change", change);
	
var performanceMenu = d3.select("#performanceSelect")
	.on("change", changePerformance);
$("#sortMe").button({label:"Sort worst to best"});
$("#countySelect").menu();
$("#performanceSelect").menu();		
function sortBars(){	
	d3.select("body").select("#incentives-chart").selectAll("svg").sort(function(a, b){		
		if(sortOrder){
			$("#sortMe").button("option", "label", "Sort best to worst");
			return d3.ascending(a.ratio, b.ratio);
		}
		else{
			$("#sortMe").button("option", "label", "Sort worst to best");
			return d3.descending(a.ratio,b.ratio);
		}	
	})
	.transition().duration(1000);
	
	sortOrder = !sortOrder;
}
performanceMenu.append("option").text("All");	
performanceMenu.append("option").text("Met promise");
performanceMenu.append("option").text("Did not meet promise");
performanceMenu.append("option").text("Funds recovered");
	
var sortOrder = false;		
d3.select("#sortMe").on("click", function() {
	sortBars();
});

d3.json("incentives.json", function(error, data) {
	data1 = data;
	for (var i=0; i<data1.length; i++){
		//get rid of some irregular ones that don't make sense with our presentation
		if(data1[i].Beneficiaries === "" || data1[i].JobsPromised === null || data1[i].JobsPromised === undefined || data[i].JobsPromised === 0 || data[i].JobsPromised === []){
			data1.splice(i, 1);
		}
		var ratio = (data1[i].JobsDelivered/data1[i].JobsPromised);
		if(ratio === undefined || isNaN(ratio) || ratio === null){
			ratio = 0;
		}
		data1[i].ratio = ratio;
		//if they exceeded promised jobs, create a new bar to show distinction. Creating property .JobsDelivered2 to hold our array
		if(ratio > 1){
			data1[i].JobsDelivered2 = [data1[i].JobsPromised, data1[i].JobsDelivered];
		}
		//rangez is expecting an array bc of what we did above 
		else{
			data1[i].JobsDelivered2 = [data[i].JobsDelivered];
		}
		
		if(data1[i].COUNTY != "Multi-County"){
			data1[i].COUNTY = data1[i].COUNTY + " County";
		}
	}

//	data1 = data1.sort(function(a, b) { return b.ratio - a.ratio; });
	doSVG(data1);

	//we only want one of each county in our menu so we need to check and see if it's already in there
	setcountyMenu = function(){
		countyMenuArr.push("All Counties");//This isn't in the data so we need to create it
		data1.filter(function(v, i) {		
				if(countyMenuArr.indexOf(v.COUNTY) != -1){ return true;}
				else{countyMenuArr.push(v.COUNTY); return false;};
		});
		return countyMenuArr.sort();//Alphabetize
	}
	//add counties from the data to the menu
	countyMenu.selectAll("option")
		.data(setcountyMenu)
		.enter().append("option")
			.text(function(d) {return d;});
});//d3.json()

var filterCounties = function(d){
	var selected = countyMenu.property("value");
	performanceMenu.property("value", "All")/*.node().focus()*/;	
	var myfilter = data1.filter(function(v) {
		if(selected != "All Counties"){return (v.COUNTY) === selected;}
		else{return true;};
	});
	//	doSVG(myfilter, counties);
	doSVG(myfilter);	
}
//might use this later to allow removal/addition of deobligated entries
/*filterObligated = function(d){
	var selected = performanceMenu.property("value");
	countyMenu.property("value", "All Counties");
	var myfilter = data1.filter(function(v) {
		if(selected != "All"){ if(selected === "Yes"){return v.Status1 === "Deob"} else{ return v.Status1 != "Deob"}}
		else{return true;};
	});	
	doSVG(myfilter);	
}*/
var filterPerformance = function(d){
	var selected = performanceMenu.property("value");
	countyMenu.property("value", "All Counties")/*.node().focus()*/;
	var myfilter = data1.filter(function(v){
		if(selected != "All"){if(selected === "Met promise"){return v.MetJobGoal === "Y"} else if(selected === "Funds recovered"){return v.Status1 === "Deob"} else{return v.MetJobGoal === "N"};}
		else{return true;};
	});
	doSVG(myfilter);
}
function doSVG(data){
	//svg = d3.select("body").data(data1).selectAll("svg")
	svg = d3.select("body").select("#incentives-chart").selectAll("svg")
	      .data(data, function(d) { return d.Serial; });//to keep the bars in the same place, get rid of the function. 
			
	svg.exit().transition().duration(0)		
	//.attr("x", -x1.rangeBand())
		.remove();

	var svgEnter = svg.enter().append("svg")
						.attr("class", "bullet")	
	      				.attr("width", width + margin.left + margin.right)
	      				.attr("height", height + margin.top + margin.bottom)
	    				.append("g")
	      					.attr("transform", "translate(" + margin.left + "," + margin.top + ")")
							.attr("class", "holder")			
	
//	d3.transition(svg).select(".holder").call(chart.duration(1000));
	svg.select(".holder").append("g").attr("class", "bars").call(chart.duration(1000));
	sortOrder = false;
	sortBars();
	//change the color of the over-acheiver bar
	svg.select(".holder")
		.attr("class", function(d){ if(d.ratio >1){return "bonus"} else{ return }});
	
		$(document).tooltip({
			items: "svg g g", 
			content: function(){ 
				var data = this.__data__;
				var tip = "<span class='tip'><span class='tiptitl'>Beneficiary:</span> ";
				if(data.longName != null){
					tip += data.longName;
				}
				else{
					tip += data.Beneficiaries;
				}
				tip += "<br/><span class='tiptitl'>Jobs Promised:</span> "+data.JobsPromised+"<br/><span class='tiptitl'>Jobs Delivered:</span> "+data.JobsDelivered+"<br/><span class='tiptitl'>Grant amount:</span> $"+data.Grant_Amt;
				if(data.Recaptured_Deob != null){
					tip += "<br/><span class='tiptitl'>Recaptured funds:</span> $"+data.Recaptured_Deob
				}
				tip += "<br/><span class='tiptitl'>Description: </span>"+data.Description+"</span>"
				return tip;
			}
		});
}//doSVG

function change() {
  clearTimeout(timeout);
filterCounties();
//svg.datum(data1).call(chart.duration(1000));
  /*d3.transition()
      .duration(750)
      .each(shuffle);*/
}
function changePerformance() {
	clearTimeout(timeout);
	filterPerformance();
}
	
var timeout = setTimeout(function() {
	//  menu.property("value", "All Counties").node().focus();
//	deobligatedMenu.property("value", "All").node().focus();
//	filterPerformance();
}, 5000);

</script>
	
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-28102445-5', 'myajc.com');
ga('send', 'pageview');
</script>
</body>
</html>